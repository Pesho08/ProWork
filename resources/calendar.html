<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProWork - Kalender</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-button,
        .today-button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.3s;
        }

        .nav-button:hover,
        .today-button:hover {
            background: #5568d3;
        }

        .month-display {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .calendar {
            padding: 30px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-header {
            text-align: center;
            font-weight: 600;
            padding: 10px;
            background: #f1f3f5;
            border-radius: 4px;
            color: #495057;
        }

        .calendar-day {
            min-height: 100px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px;
            background: white;
            position: relative;
            transition: box-shadow 0.3s;
        }

        .calendar-day:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .day-number {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .other-month {
            background: #f8f9fa;
            color: #adb5bd;
        }

        .today {
            background: #e7f5ff;
            border: 2px solid #667eea;
        }

        .task-item {
            font-size: 0.75rem;
            padding: 3px 6px;
            margin: 2px 0;
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            border-left: 3px solid;
            transition: transform 0.2s;
        }

        .task-item:hover {
            transform: translateX(2px);
        }

        .task-TEST {
            background: #ffe3e3;
            border-left-color: #fa5252;
            color: #c92a2a;
        }

        .task-HOMEWORK {
            background: #d0ebff;
            border-left-color: #339af0;
            color: #1864ab;
        }

        .task-MEETING {
            background: #d3f9d8;
            border-left-color: #51cf66;
            color: #2b8a3e;
        }

        .task-TRAINING {
            background: #ffec99;
            border-left-color: #ffd43b;
            color: #f08c00;
        }

        .task-WORK {
            background: #e7e7e7;
            border-left-color: #868e96;
            color: #495057;
        }

        .more-tasks {
            font-size: 0.7rem;
            color: #667eea;
            margin-top: 3px;
            cursor: pointer;
            font-weight: 500;
        }

        .priority-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .priority-HIGH {
            background: #fa5252;
        }

        .priority-MEDIUM {
            background: #fd7e14;
        }

        .priority-LOW {
            background: #74c0fc;
        }

        .bottom-actions {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .action-button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }

        .action-button:hover {
            background: #5568d3;
        }

        .action-button.secondary {
            background: #495057;
        }

        .action-button.secondary:hover {
            background: #343a40;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ProWork Kalender</h1>
            <p>Deine Aufgaben im Überblick</p>
        </div>

        <div class="navigation">
            <div class="nav-buttons">
                <button class="nav-button" onclick="previousMonth()">← Vorheriger</button>
                <button class="today-button" onclick="goToToday()">Heute</button>
                <button class="nav-button" onclick="nextMonth()">Nächster →</button>
            </div>
            <div class="month-display" id="monthDisplay"></div>
        </div>

        <div class="calendar">
            <div class="calendar-grid">
                <div class="calendar-header">Mo</div>
                <div class="calendar-header">Di</div>
                <div class="calendar-header">Mi</div>
                <div class="calendar-header">Do</div>
                <div class="calendar-header">Fr</div>
                <div class="calendar-header">Sa</div>
                <div class="calendar-header">So</div>
                <!-- Calendar days will be inserted here -->
                <div id="calendarDays"></div>
            </div>
        </div>

        <div class="bottom-actions">
            <button class="action-button secondary" onclick="goToTaskList()">Zur Aufgabenliste</button>
            <button class="action-button" onclick="refreshCalendar()">Aktualisieren</button>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let allTasks = [];

        // Wait for JavaBridge to be available
        function waitForJavaBridge() {
            const checkBridge = setInterval(function () {
                if (typeof javaBridge !== 'undefined') {
                    clearInterval(checkBridge);
                    init();
                }
            }, 100);
        }

        function init() {
            loadTasks();
            renderCalendar();
        }

        function loadTasks() {
            try {
                const tasksJson = javaBridge.getAllTasks();
                allTasks = JSON.parse(tasksJson);
                console.log('Loaded tasks:', allTasks.length);
            } catch (error) {
                console.error('Error loading tasks:', error);
                allTasks = [];
            }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Update month display
            const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni',
                'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            document.getElementById('monthDisplay').textContent = `${monthNames[month]} ${year}`;

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();

            // Get day of week (0 = Sunday, 1 = Monday, etc.)
            // Adjust so Monday = 0
            let firstDayOfWeek = firstDay.getDay() - 1;
            if (firstDayOfWeek < 0) firstDayOfWeek = 6;

            // Previous month days
            const prevMonth = new Date(year, month, 0);
            const daysInPrevMonth = prevMonth.getDate();

            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';

            // Add previous month days
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const dayDiv = createDayCell(daysInPrevMonth - i, true);
                calendarDays.appendChild(dayDiv);
            }

            // Add current month days
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = (year === today.getFullYear() &&
                    month === today.getMonth() &&
                    day === today.getDate());
                const dayDiv = createDayCell(day, false, isToday, new Date(year, month, day));
                calendarDays.appendChild(dayDiv);
            }

            // Add next month days to fill grid
            const totalCells = calendarDays.children.length;
            const remainingCells = 42 - totalCells; // 6 weeks * 7 days
            for (let day = 1; day <= remainingCells; day++) {
                const dayDiv = createDayCell(day, true);
                calendarDays.appendChild(dayDiv);
            }
        }

        function createDayCell(day, isOtherMonth, isToday = false, date = null) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';

            if (isOtherMonth) {
                dayDiv.classList.add('other-month');
            }

            if (isToday) {
                dayDiv.classList.add('today');
            }

            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            dayDiv.appendChild(dayNumber);

            // Add tasks for this day (only if not other month)
            if (!isOtherMonth && date) {
                const tasksForDay = getTasksForDate(date);
                const maxVisible = 3;

                tasksForDay.slice(0, maxVisible).forEach(task => {
                    const taskDiv = createTaskElement(task);
                    dayDiv.appendChild(taskDiv);
                });

                if (tasksForDay.length > maxVisible) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'more-tasks';
                    moreDiv.textContent = `+${tasksForDay.length - maxVisible} weitere`;
                    moreDiv.onclick = () => showAllTasksForDay(date, tasksForDay);
                    dayDiv.appendChild(moreDiv);
                }
            }

            return dayDiv;
        }

        function getTasksForDate(date) {
            const dateStr = formatDateISO(date);

            // WICHTIG: Filtere Tasks mit Wiederholung raus!
            return allTasks.filter(task => {
                // Nur Tasks ohne Wiederholung anzeigen
                if (task.repetition !== 'NONE') {
                    return false;
                }
                return task.dueDate === dateStr;
            }).sort((a, b) => {
                // Sort by priority (HIGH > MEDIUM > LOW)
                const priorityOrder = { 'HIGH': 0, 'MEDIUM': 1, 'LOW': 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
        }

        function formatDateISO(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateDE(dateStr) {
            // Konvertiere YYYY-MM-DD zu DD.MM.YYYY
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return `${parts[2]}.${parts[1]}.${parts[0]}`;
            }
            return dateStr;
        }

        function createTaskElement(task) {
            const taskDiv = document.createElement('div');
            taskDiv.className = `task-item task-${task.taskType}`;

            const indicator = document.createElement('span');
            indicator.className = `priority-indicator priority-${task.priority}`;

            const taskName = document.createTextNode(task.name);

            taskDiv.appendChild(indicator);
            taskDiv.appendChild(taskName);

            taskDiv.onclick = () => showTaskDetails(task);

            return taskDiv;
        }

        function showTaskDetails(task) {
            let details = `Aufgabe: ${task.name}\n\n`;
            details += `Typ: ${task.taskType}\n`;
            details += `Priorität: ${task.priority}\n`;
            details += `Fällig: ${task.dueDate.split('-').reverse().join('.')}\n`;  // ← HIER ändern!
            details += `Wiederholung: ${task.repetition}\n`;

            if (task.notes && task.notes.trim() !== '') {
                details += `\nNotizen:\n${task.notes}`;
            }

            alert(details);
        }

        function showAllTasksForDay(date, tasks) {
            const dateStr = date.toLocaleDateString('de-DE');  // ← Oder hier auch .split('-').reverse().join('.')
            let message = `Aufgaben für ${dateStr}:\n\n`;

            tasks.forEach((task, index) => {
                message += `${index + 1}. ${task.name} (${task.priority})\n`;
            });

            alert(message);
        }


        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }

        function refreshCalendar() {
            loadTasks();
            renderCalendar();
        }

        function goToTaskList() {
            javaBridge.switchToListView();
        }

        // Start when page loads
        waitForJavaBridge();
    </script>
</body>

</html>